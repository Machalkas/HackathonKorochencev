{% extends "base.html" %}
{% load static %}
<!-- https://bootstrap-4.ru/docs/4.0/components/navs/#javascript-behavior -->
<!-- https://bootstrap-4.ru/docs/4.0/components/dropdowns/ -->
<!-- https://bootstrap-4.ru/docs/4.0/components/modal/ -->
{% block head%}
<link rel="stylesheet" href="{% static 'css/join.css'%}">
{% endblock head %}
{% block title %}Хакатон | Сброс пароля{% endblock title %}
{% block content %}
{% include "header.html" %}
<div class="base-container d-flex w-100 h-100 p-3 pt-md-5 mx-auto flex-column">
    <main role="main" class="inner cover" id="main">
        <h1 class="cover-heading display-4" id='name'>Сброс пароля</h1>
        <p>Введите email на который будет отправлена ссылка для сброса пароля</p>
        <form method="post" class="form mt-3" id="password_form">
            {% csrf_token %}
            <input type="password" name="password1" class="form-control mt-1" placeholder="Пароль" maxlength="254" required="" id="id_pass1">
            <input type="password" name="password2" class="form-control mt-1" placeholder="Повторите пароль" maxlength="254" required="" id="id_pass2">
            <p id="error_mess"></p>
            <!-- <input type="button" value="Отправить" onclick="sendEmail()" class="btn btn-primary btn-blue mt-3" id="btn_submit"> -->
          </form>
          <button href="#" class="btn btn-primary" onclick="sendEmail()" id="btn_submit">Отправить</button>
    </main>
    <!-- <footer class=" mastfoot mt-auto">
            <div class="inner">
                <p>Machalka</p>
            </div>
        </footer> -->
</div>
{% endblock content %}
{%block scripts%}
<script src="{% static 'js/cookie.js' %}"></script>
<script>
    function sendEmail(){
        let btn=$("#btn_submit");
        $("#error_mess").text('');
        btn.prop("disabled",true);
        btn.text("Загрузка...");
        let pass1=$("#password_form").find("input[name=password1]").val();
        let pass2=$("#password_form").find("input[name=password2]").val();
        if (pass1!=pass2){
            $("#error_mess").text("Пароли не совпадают");
            btn.prop("disabled",false);
            btn.text("Отправить");
        }else{
        $.ajax({
            url: '/auth/ajax',
            method: 'post',
            dataType: 'json',
            headers: { "X-CSRFToken": getCookie("csrftoken") },
            data: {"action":"set-new-password", "password":pass1, "token":$(location).attr('pathname').split("/").pop()},
            success: function (data) {
                $("#main").html('<h1 class="cover-heading display-4" id="name">Сброс пароля</h1><h3 class="mt-3">Пароль успешно сброшен</h3>');
            },
            error: function (data) {
                data = JSON.parse(data["responseText"]);
                console.log(data);
                $("#error_mess").text(data["error"]);
                btn.prop("disabled",false);
                btn.text("Отправить");
                // let errors="";
                // errors+='<p class="lead" style="font-size: 1em;">'+data["error"]+'</p>\n';
                // login_result_form.innerHTML=errors;
                // login_result_form.style=style;
            }
        });
    }
    }
</script>
{%endblock scripts%}